<!DOCTYPE html>
<html>
  <head>
    <title>Squid's Tools</title>
    <link rel="stylesheet" href="./css/styles.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <script type="text/javascript" src="/eel.js"></script>
</head>

<body>

<div class="dark">
  <h1 class="editable">Squid's Tools</h1>
</div>

<div class="row">
  <div class="left-col dark2">

    <div class="dark2 light">
      <h5>Encounter List</h5>
      <div class="openBtn">
        <button onclick="openForm()"><strong>Create</strong></button>
      </div>
    </div>

  <div class="encounter_selection">
<!--    <div class="encounter_block">Test</div>-->
<!--    <div class="encounter_block">Test</div>-->
<!--    <div class="encounter_block">Test</div>-->
<!--    <div class="encounter_block">Test</div>-->
<!--    <div class="encounter_block">Test</div>-->
<!--    <div class="encounter_block">Test</div>-->
<!--    <div class="encounter_block">Test</div>-->


  </div>
  </div>

  <div id="selected_encounter" class="selected_encounter dark">



<!--    <div class="monster_block dark1 light">-->
<!--      <div><span class="monster_name">Ogre</span><span class="glyphicon glyphicon-trash al-right"></span></div>-->
<!--      <div class="gradient"></div>-->

<!--      <div class="light stat_small">-->
<!--        <div><span class="bold">Armor Class</span><span> 11 (hide armor)</span></div>-->
<!--        <div><span class="bold">Hit Points</span><span> 59 (7d10+21)</span></div>-->
<!--        <div><span class="bold">Speed</span><span> 40 ft.</span></div>-->
<!--      </div>-->
<!--    </div>-->

<!--    <div id="Monster1" class="monster_block">Test</div>-->
<!--    <div class="monster_block">Test</div>-->
<!--    <div class="monster_block">Test</div>-->
<!--    <div class="monster_block">Test</div>-->
<!--    <div class="monster_block">Test</div>-->
<!--    <div class="monster_block">Test</div>-->
<!--    <div class="monster_block">Test</div>-->
<!--    <div class="monster_block">Test</div>-->
<!--    <div class="monster_block">Test</div>-->
<!--    <div class="monster_block">Test</div>-->
<!--    <div class="monster_block">Test</div>-->
  </div>

  <div id="stat_block" class="stat_block">

  </div>

</div>



<div class="loginPopup">
  <div class="formPopup" id="popupForm">
      <form class="formContainer">

        <div>
          <span>Monster Name: </span>
          <span>
            <select id="select-state" class="js-example-data-array" placeholder="Pick a state...">
                    <option value="">Select a state...</option>
            </select>
          </span>
          <span>
            <button type="button" class="btn" onclick="addSelection()">Add</button>
          </span>
        </div>

<!--  List Selected Monsters -->
        <div class="stat_small">
        <table id="Encounter-Builder-Table">

        <colgroup>
        <col span="1" style="width: 30%;">
        <col span="1" style="width: 50%;">
        <col span="1" style="width: 10%;">
        <col span="1" style="width: 10%;">
        <col span="1" style="width: 10%;">
        </colgroup>

        <tbody>
        <tr>
          <th>Creature Name</th>
          <th>Weapons</th>
          <th># Minions</th>
          <th># Bosses</th>
          <th>Generate Loot? (Items)</th>
          <th></th>
        </tr>

        </tbody>

        </table>
        </div>
        <div>
          <button type="button" class="btn cancel" onclick="closeForm()">Cancel</button>
          <button type="button" class="btn cancel" onclick="sendForm()">Create</button>
        </div>




      </form>
  </div>
</div>


</body>

<script type="text/javascript">

</script>

<script>
$(document).ready(function() {
  $("#Monster1").click(async function () {
    let html_block = await eel.get_stat_block()();
    // $("#stat_block").html(html_block)
    document.getElementById("stat_block").innerHTML = html_block;
    // alert("The paragraph was clicked.");

  });

  var selected_encounter_id = 0

  // $(".editable").dblclick(function (event){
  //   console.log(event)
  // });

  eel.get_monster_list()().then(function (result) {
    console.log(result)
    $('#select-state').select2(
            {data: result}
    );
  });

    refresh_encounter_list()
});

function refresh_encounter(){
    load_encounter(selected_encounter_id);
}

function load_encounter(encounter_id){
    eel.load_encounter(encounter_id)().then(function (result) {
      $('.selected_encounter').html(result)
      selected_encounter_id = encounter_id;
    });
}

function load_token_stat_block(encounter_id, token_id){
    eel.load_token_stat_block(encounter_id, token_id)().then(function (result) {
      $('#stat_block').html(result)
    });
}

// stat_block on change event
// var editable = document.getElementById('text');
// editable.addEventListener('input', function() {
//     console.log('Hey, somebody changed something in my text!');
// });


function change_p_init(encounter_id, token_id, inputid){
    console.log(inputid)
    let new_init = document.getElementById(inputid).value;
    console.log(new_init)
    eel.change_p_init(encounter_id, token_id, new_init)().then(function (result) {
      refresh_encounter_list();
      refresh_encounter();
    });
}


function change_t_hp(encounter_id, token_id, inputid) {
  console.log(inputid)
  let new_init = document.getElementById(inputid).value;
  console.log(new_init)
  eel.change_t_hp(encounter_id, token_id, new_init)().then(function (result) {
    refresh_encounter_list();
    refresh_encounter();
  });
}
function change_t_name(encounter_id, token_id, inputid){
    console.log(inputid)
    let new_init = document.getElementById(inputid).value;
    console.log(new_init)
    eel.change_t_name(encounter_id, token_id, new_init)().then(function (result) {
      refresh_encounter_list();
      refresh_encounter();
    });
}

async function get_weapon_list(){
  await eel.get_weapon_list()().then(function(result){
    console.log(result)
    $('.weapon-selection').select2(
        {
          data: result,
          width: '100%'
        }
  );
  });
}

function refresh_encounter_list(){
    eel.get_encounter_list()().then(function (result) {
        $('.encounter_selection').html(result)
    });
}

  // async function get_monster_list(){
  //   await eel.get_monster_list()().then(function(result){
  //     $('.js-example-data-array').select2(
  //         {data: result}
  //   );
  //   });
  // }

  // get_monster_list()
  // $('.weapon-selection').select2({ width: '100%' });

</script>
<script>

    function openForm() {
      document.getElementById("popupForm").style.display = "block";
    }
    function closeForm() {
      document.getElementById("popupForm").style.display = "none";
    }

    async function addSelection() {
      let jsarr = $('.js-example-data-array').select2('data');
      await eel.add_monster_to_encounter_builder(jsarr)().then(function(result) {
        $('#Encounter-Builder-Table > tbody:last-child').append(result)
        get_weapon_list();
      });
    }

    function sendForm() {
      document.getElementById("popupForm").style.display = "none";
      console.log("TEST");
      let arr = [];
      $('#Encounter-Builder-Table > tbody > tr').each(function(index, tr) {
        if (index === 0) {
          return;
        }
        let tds = $(this).find('td');
        console.log(tr);
        let name = tds[0].innerText;
        let weapon = $(this).find(".weapon-selection").select2('data');
        let minions = parseInt(tds[2].getElementsByTagName('input')[0].value);
        let bosses = parseInt(tds[3].getElementsByTagName('input')[0].value);
        let loot = tds[4].getElementsByTagName('input')[0].checked;
        arr.push({
          "name": name,
          "weapons": weapon,
          "minion_count": minions,
          "boss_count": bosses,
          "loot": loot});

      });

      eel.create_encounter(arr)().then(function(result) {
        refresh_encounter_list();
      });

    }

</script>

<!--  ;-->

<!--<script>-->
<!--  $(document).ready(function(){-->
<!--  $("#selected_encounter").contextmenu(function(e){-->
<!--    e.preventDefault();-->
<!--    $("#contextMenu").css({display: "block", left:e.pageX, top:e.pageY});-->
<!--  });-->
<!--    $(document).click(function(){-->
<!--        $("#contextMenu").hide();-->
<!--    });-->
<!--});-->
<!--</script>-->